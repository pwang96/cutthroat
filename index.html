<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cutthroat!</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.2.1.min.js"></script>
    <script>
var ws;
var playerName;
var playerId;

$().ready(function () {
    $("#mainScreen").show()
    $("#playScreen").hide()
    $("#btnConnect").click(function () {
        playerName = $("#playerName").val()
        $("#status").text("connecting...");
        ws_url = "ws://" + location.host + "/connect"
        ws = new WebSocket(ws_url);
        ws.onopen = openHandler;
        ws.onmessage = messageHandler;
        ws.onerror = function (e) {
            $("#status").text(e.message);
        };
    });
    $("#btnDisconnect").click(function () {
        ws.close();
        $("#playScreen").hide();
        $("#mainScreen").show();
        $(document).unbind("keypress", keyHandler);
    });
    $("#btnJoin").click(function () {
        sendMessage(["join"]);
    });
    $("#btnPlayWord").click(function() {
        word = $("#word").val();
        sendMessage(["play_word", word]);
    });
    $("#btnDrawTile").click(function() {
        sendMessage(["draw_tile"]);
    });
    $("#btnAddBot").click(function() {
        sendMessage(["add_bot"]);
    });

});

function sendMessage(msgArray) {
    var msg = JSON.stringify(msgArray);
    ws.send(msg);
}

function openHandler(e){
    $("#status").text("connected to server");
    playerName = $('#playerName').val();
    sendMessage(["new_player", playerName]);
    $("#mainScreen").hide();
    $("#playScreen").show();
}

function messageHandler(e){
    //$("#status").text(e.data);
    args = JSON.parse(e.data);
    var cmd = args[0];

    switch(cmd){
        case("handshake"):
            $("#username").text(args[1]);
            playerId = args[2];
            break

        case("game_full"):
            $("#notification").text("Sorry! The game is full.")
            break

        case("update"):
            var free_tiles = args[1];
            var players = args[2];
            $("#freeTiles").text("[" + free_tiles + "]");
            $("#table").empty();
            $.each(players, function(player_name,words){
                var entry = "<p>" + player_name + ": [" + words + "]</p>"
                $("#table").append(entry)
            });
            break

        case("p_joined"):
            var id = args[1];
            var name = args[2];
            if(id == playerId)
                $("#btnJoin").css("visibility", "hidden");
            $("#notification").text(name + " has joined!");
            break

        case("valid_word"):
            var word = args[1];
            var name = args[2];
            $("#notification").text(name + " played " + word);
            break

        case("invalid_word"):
            var word = args[1];
            $("#notification").text(word + " is not valid!");
            break

        case("scores"):
            var scores = args[1];
            $("#scoresList").empty();
            for (var i = 0; i < scores.length; i++) {
                var name = scores[i][0];
                var score = scores[i][1];
                $("#scoresList").append("<p>" + name + ": " + score + "</p>");
            }
            break

        case("dc"):
            var name = args[1];
            $("#notification").text(name + " has disconnected");
            break

        case("p_gameover"):
            id = args[1];
            $("#player" + id).remove();
            if(id == playerId)
                $("#btnJoin").css("visibility", "visible");
            break
    }
}

    </script>
</head>
<body>
<div id="status" style="text-align:left">&nbsp;</div>

<div style="font-size: 3em;">WELCOME TO CUTTHROAT :)</div>

<div style="margin-top:1em">
    <div id="mainScreen">
        <div id="connectForm">
            <span style="color: white">Name</span>
            <input id="playerName" type="text" maxlength="15" />
            <button id="btnConnect">Connect</button>
        </div>
    </div>

    <div id="playScreen">
        <div id="userForm">
            Welcome to the server, <span id="username"></span>! Invite some friends and Join.
        </div>
        <div id="joinBtnField">
            <button id="btnJoin">Join!</button>
        </div>

        <div id="playField">
            <div id="notification"></div>
            <button id="btnAddBot">Play a Bot!</button>
            <button id="btnDrawTile">Draw Tile</button>
            <div id="freeTiles"></div>
            <div id="table"></div>
            <div id="submitField">
                <input id="word" type="text" maxlength="20" />
                <button id="btnPlayWord">Play Word</button>
            </div>
            <div id="scores">
                <div>Scores</div>
                <div id="scoresList"></div>
            </div>
        </div>

    </div>
</div>

</body>
</html>